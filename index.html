<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SSAP TV Launcher</title>
  <style>
    body { 
      background:#0b0b0b; 
      margin:0; 
      font-family:sans-serif; 
      color:#fff; 
      text-align:center;
      overflow-y: auto; 
      height: 100vh;
    }
    h2 { margin:20px 0; }
    .grid { 
      display:grid; 
      grid-template-columns:repeat(5,1fr); 
      gap:20px; 
      padding:40px; 
    }
    .tile {
      background:#1a1a1a; 
      border:3px solid transparent; 
      border-radius:12px;
      text-align:center; 
      padding:12px; 
      transition:border-color 0.2s, background 0.2s;
      cursor:pointer;
    }
    .tile img { 
      width:96px; 
      height:96px; 
      object-fit:contain; 
      margin-bottom:10px; 
    }
    .tile span { 
      display:block; 
      font-size:14px; 
      color:#ddd; 
    }
    .tile.active { 
      border-color:#4af; 
      background:#222; 
    }
    #log { 
      white-space:pre; 
      text-align:left; 
      background:#111; 
      padding:10px; 
      margin:20px auto; 
      max-width:900px; 
      border-radius:8px; 
      font-size:13px; 
    }
  </style>
</head>
<body>
  <h2>ðŸ“º LG webOS SSAP Launcher</h2>

  <div class="grid" id="grid">
    <div class="tile active" data-id="com.webos.app.photovideo" data-title="Photo & Video" data-thumb="https://img.icons8.com/fluency/96/video.png"></div>
    <div class="tile" data-id="com.webos.app.browser" data-title="Web Browser" data-thumb="https://img.icons8.com/fluency/96/internet.png"></div>
    <div class="tile" data-id="youtube.leanback.v4" data-title="YouTube Leanback" data-thumb="https://img.icons8.com/fluency/96/youtube-play.png"></div>
    <div class="tile" data-id="com.webos.app.installation" data-title="Secret Menu" data-thumb="https://img.icons8.com/fluency/96/settings.png"></div>
    <div class="tile" data-id="com.webos.app.music" data-title="Music" data-thumb="https://img.icons8.com/fluency/96/musical-notes.png"></div>
    <div class="tile" data-id="com.palm.app.settings" data-title="Settings" data-thumb="https://img.icons8.com/fluency/96/settings--v1.png"></div>
    <div class="tile" data-id="com.webos.app.cheeringtv" data-title="Cheering TV" data-thumb="https://img.icons8.com/fluency/96/speaker.png"></div>
    <div class="tile" data-id="com.webos.app.discovery" data-title="LG Content Store" data-thumb="https://img.icons8.com/fluency/96/shopping-bag.png"></div>
    <div class="tile" data-id="com.webos.app.home" data-title="Home" data-thumb="https://img.icons8.com/fluency/96/home.png"></div>
    <div class="tile" data-id="com.webos.app.fullhome" data-title="New Home" data-thumb="https://img.icons8.com/fluency/96/home-page.png"></div>
  </div>

  <div id="log"></div>

  <!-- Additional required scripts -->
  <script src="https://raw.githubusercontent.com/webosappclub/webosappclub.github.io/refs/heads/main/msx/instart/webOSTV.js"></script>
  <script src="https://raw.githubusercontent.com/webosappclub/webosappclub.github.io/refs/heads/main/msx/instart/webOSTV-dev.js"></script>
  <script src="https://dropbox.inf.re/webos-gfn/wsproxy.js"></script>
  <script src="https://dropbox.inf.re/webos-gfn/client.js"></script>

  <script>
    const LOG = document.getElementById('log');
    const tiles = [...document.querySelectorAll('.tile')];
    let index = 0;
    let client;
    let useLegacyRequest = false;

    function log(m){
      LOG.textContent = `[${new Date().toLocaleTimeString()}] ${m}\n` + LOG.textContent;
    }

    // detect Chrome version
    const ua = navigator.userAgent;
    const match = ua.match(/Chrome\/(\d+)/);
    const chromeVersion = match ? parseInt(match[1], 10) : 0;
    useLegacyRequest = chromeVersion <= 53; // <=53 use legacy

    log("Detected Chrome version: " + chromeVersion + " -> using " + (useLegacyRequest?"legacy request":"SSAPClient"));

    // decorate each tile with icon + title and onclick
    tiles.forEach((tile, i)=>{
      tile.innerHTML = `<img src="${tile.dataset.thumb}"><span>${tile.dataset.title}</span>`;
      tile.onclick = () => { updateFocus(i); launchApp(tile); };
    });

    async function initClient(){
      if(client) return client;
      if(useLegacyRequest) return null; // no client needed for legacy
      const target = "127.0.0.1";
      client = new SSAPClient(target, window.localStorage["client-key-"+target]);
      log("Connecting...");
      await client.connect();
      log("Registering...");
      window.localStorage["client-key-"+target] = await client.register();
      log("Registered.");
      return client;
    }

    async function launchApp(tile){
      if(useLegacyRequest){
        // legacy var request
        try{
          log("Launching (legacy) " + tile.dataset.id);
          var request = webOS.service.request("luna://com.webos.service.applicationManager", {
            method: "launch",
            parameters: { id: tile.dataset.id },
            onSuccess: function(msg){ log("Launch success: "+JSON.stringify(msg)); },
            onFailure: function(err){ log("Launch failed: "+JSON.stringify(err)); }
          });
        }catch(e){
          log("Legacy launch error: "+e);
        }
      } else {
        // modern SSAPClient
        try{
          const cli = await initClient();
          log("Launching " + tile.dataset.id);
          await cli.request({
            uri: "ssap://system.launcher/launch",
            payload: { id: tile.dataset.id }
          });
          log("Launch sent: " + tile.dataset.id);
        }catch(e){
          console.error(e);
          log("Launch failed: " + e);
        }
      }
    }

    function updateFocus(newIndex){
      tiles[index].classList.remove("active");
      index = (newIndex + tiles.length) % tiles.length;
      tiles[index].classList.add("active");
      tiles[index].scrollIntoView({behavior:"smooth", block:"center"});
    }

    // keyboard nav
    window.addEventListener("keydown",ev=>{
      if(ev.key==="ArrowRight") updateFocus(index+1);
      else if(ev.key==="ArrowLeft") updateFocus(index-1);
      else if(ev.key==="ArrowDown") updateFocus(index+5);
      else if(ev.key==="ArrowUp") updateFocus(index-5);
      else if(ev.key==="Enter") launchApp(tiles[index]);
    });

    (async()=>{
      if(!useLegacyRequest){
        try{ await initClient(); }
        catch(e){ log("Init failed: "+e); }
      }
    })();
  </script>
</body>
</html>
